# LiteTravel LLM å¤„ç†æµç¨‹å…¨è§£æ

> **å°çº¢ä¹¦çˆ¬å– â†’ LLM åˆ†æ â†’ å‰ç«¯æ¸²æŸ“** å®Œæ•´æ•°æ®æµæ–‡æ¡£

---

## ğŸ“Š æ¶æ„æ€»è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ç”¨æˆ·   â”‚ è¾“å…¥: "é•¿æ²™ç¾é£Ÿæ¨è"
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. ç”¨æˆ·äº¤äº’
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Frontend (React + Zustand)          â”‚
â”‚  src/components/views/DiningView.tsx         â”‚
â”‚  - ç”¨æˆ·è¾“å…¥æœç´¢å…³é”®è¯                          â”‚
â”‚  - è°ƒç”¨ analyzeService.analyzeSearch()       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. HTTP POST /api/analyze/search
       â”‚    { keyword, city, source, limit }
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Backend API (FastAPI)                    â”‚
â”‚  backend/app/api/analyze.py                  â”‚
â”‚  - æ¥æ”¶æœç´¢è¯·æ±‚                               â”‚
â”‚  - æ ¹æ® source æ‰§è¡Œ auto/æŒ‡å®šæ•°æ®æº/é™çº§é€»è¾‘   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. æ•°æ®è·å–
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Data Source Layer                        â”‚
â”‚  backend/app/services/llm/data_sources.py    â”‚
â”‚  - MockDataSource (æµ‹è¯•æ•°æ®)                 â”‚
â”‚  - XiaohongshuDataSource (çˆ¬è™«é€‚é…å™¨)        â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. çˆ¬å–æ•°æ®
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Scraper (MediaCrawler)                   â”‚
â”‚  scrapers/xhs/adapter.py                     â”‚
â”‚  - è°ƒç”¨ MediaCrawler çˆ¬å–å°çº¢ä¹¦              â”‚
â”‚  - è¿”å› XhsNote[] (æ ‡é¢˜ã€å†…å®¹ã€æ ‡ç­¾ã€äº’åŠ¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 5. æ•°æ®æ ‡å‡†åŒ–
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Data Normalization                       â”‚
â”‚  è½¬æ¢ä¸ºç»Ÿä¸€çš„ NoteData æ ¼å¼:                  â”‚
â”‚  - id, title, content                        â”‚
â”‚  - tags, location, city                      â”‚
â”‚  - likes, collects, comments                 â”‚
â”‚  - content_type (æ™¯ç‚¹/ç¾é£Ÿ/ä½å®¿/å‡ºè¡Œ)         â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 6. LLM å¤„ç† Pipeline
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     LLM Pipeline                             â”‚
â”‚  backend/app/services/llm/pipeline.py        â”‚
â”‚                                              â”‚
â”‚  Step 1: TextCleaner æ–‡æœ¬æ¸…æ´—                â”‚
â”‚    - ç§»é™¤ç‰¹æ®Šå­—ç¬¦ã€emoji                      â”‚
â”‚    - æ ‡å‡†åŒ–æ ¼å¼                               â”‚
â”‚                                              â”‚
â”‚  Step 2: PromptManager æ„å»º Prompt          â”‚
â”‚    - æ ¹æ® content_type é€‰æ‹©æ¨¡æ¿              â”‚
â”‚    - travel_analysis (æ™¯ç‚¹)                  â”‚
â”‚    - dining_analysis (ç¾é£Ÿ)                  â”‚
â”‚    - hotel_analysis (ä½å®¿)                   â”‚
â”‚                                              â”‚
â”‚  Step 3: LLMProvider (Volcengine)           â”‚
â”‚    - è°ƒç”¨è±†åŒ…å¤§æ¨¡å‹ API                       â”‚
â”‚    - model: doubao-seed-1-6-251015                   â”‚
â”‚    - temperature: 0.3                        â”‚
â”‚    - max_tokens: 4096                        â”‚
â”‚                                              â”‚
â”‚  Step 4: ResponseParser è§£æå“åº”             â”‚
â”‚    - æå– JSON ç»“æ„                          â”‚
â”‚    - éªŒè¯å­—æ®µå®Œæ•´æ€§                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 7. ç»“æ„åŒ–è¾“å‡º
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     AnalysisResult                           â”‚
â”‚  {                                           â”‚
â”‚    sentiment: "positive" | "negative" | ...  â”‚
â”‚    user_intent: "recommendation" | ...       â”‚
â”‚    summary: "æ ¸å¿ƒå†…å®¹æ‘˜è¦"                    â”‚
â”‚    keywords: ["å…³é”®è¯1", "å…³é”®è¯2"]          â”‚
â”‚    places: [                                 â”‚
â”‚      { name: "æ©˜å­æ´²", type: "æ™¯ç‚¹" }        â”‚
â”‚    ],                                        â”‚
â”‚    price_info: { min: 80, max: 150 },       â”‚
â”‚    tips: ["å®ç”¨å»ºè®®1", "å®ç”¨å»ºè®®2"],         â”‚
â”‚    highlights: ["äº®ç‚¹1", "äº®ç‚¹2"]            â”‚
â”‚  }                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 8. API å“åº”
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     BatchAnalysisResult                      â”‚
â”‚  {                                           â”‚
â”‚    results: [AnalysisResult, ...],          â”‚
â”‚    total_count: 5,                          â”‚
â”‚    success_count: 5,                        â”‚
â”‚    failed_count: 0,                         â”‚
â”‚    processing_time: 3.24                    â”‚
â”‚  }                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 9. å‰ç«¯æ¸²æŸ“
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     UI Rendering                             â”‚
â”‚  - AnalysisResultCard ç»„ä»¶å±•ç¤ºç»“æœ           â”‚
â”‚  - æƒ…æ„Ÿæ ‡ç­¾ (æ­£é¢/è´Ÿé¢/ä¸­æ€§)                  â”‚
â”‚  - æ‘˜è¦å’Œå…³é”®è¯                               â”‚
â”‚  - æå–çš„åœ°ç‚¹åˆ—è¡¨                             â”‚
â”‚  - ä»·æ ¼åŒºé—´                                   â”‚
â”‚  - å®ç”¨å»ºè®®åˆ—è¡¨                               â”‚
â”‚  - å¯å±•å¼€æŸ¥çœ‹è¯¦æƒ…                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 1. å‰ç«¯äº¤äº’å±‚

**æ–‡ä»¶**: `src/components/views/AttractionsView.tsx` (åŠå…¶ä»– View)

```typescript
const handleSearch = async () => {
  const response = await analyzeService.analyzeSearch({
    keyword: searchQuery,      // ç”¨æˆ·è¾“å…¥
    city: confirmedCity,       // å½“å‰åŸå¸‚
    source: "auto",            // æ•°æ®æº: auto(é»˜è®¤) / xiaohongshu / mock
    limit: 5,                  // è¿”å›æ•°é‡
  });
  
  if (response.success) {
    setSearchResults(response.data.results);
  }
};
```

**å…³é”®çŠ¶æ€**:
- `isSearching`: åŠ è½½çŠ¶æ€
- `searchError`: é”™è¯¯ä¿¡æ¯
- `searchResults`: AnalysisResult[]

---

### 2. API å®¢æˆ·ç«¯

**æ–‡ä»¶**: `src/services/api/analyzeService.ts`

```typescript
export const analyzeService = {
  async analyzeSearch(request: AnalyzeSearchRequest) {
    return apiClient.post<BatchAnalysisResponse>(
      '/analyze/search',
      request,
      false  // ä¸éœ€è¦è®¤è¯
    );
  }
};
```

**å…³é”®è¯´æ˜**ï¼š
- å‰ç«¯é€šè¿‡ `AnalyzeSearchRequest.source` æ§åˆ¶æ•°æ®æºï¼š`auto` / `xiaohongshu` / `mock`ã€‚
- æ¨èé»˜è®¤ä½¿ç”¨ `source: "auto"`ï¼ˆçœŸå®æ•°æ®ä¼˜å…ˆï¼Œå¤±è´¥è‡ªåŠ¨é™çº§åˆ° mockï¼‰ã€‚
- ç±»å‹å®šä¹‰ä¸è¯·æ±‚å‚æ•°è§ï¼š`src/services/api/analyzeService.ts`ã€‚

### AnalysisResult (è¾“å‡º)

ç»“æœæ¨¡å‹ä»¥ä»£ç ä¸ºå‡†ï¼š`backend/app/services/llm/models.py`ã€‚

---

## è°ƒç”¨ç¤ºä¾‹

```bash
# 1. å¯åŠ¨åç«¯
cd backend && uv run uvicorn main:app --reload --port 8000

# 2. æµ‹è¯•æœç´¢ API
curl -X POST http://localhost:8000/api/analyze/search \
  -H "Content-Type: application/json" \
  -d '{
    "keyword": "é•¿æ²™ç¾é£Ÿ",
    "city": "é•¿æ²™",
    "source": "auto",
    "limit": 3
  }'

# 3. æŸ¥çœ‹çŠ¶æ€
curl http://localhost:8000/api/analyze/status
```

### å‰ç«¯è°ƒç”¨

```typescript
// 1. ç”¨æˆ·ç‚¹å‡»æœç´¢
<button onClick={handleSearch}>AI æ™ºèƒ½åˆ†æ</button>

// 2. è°ƒç”¨åç«¯
const response = await analyzeService.analyzeSearch({
  keyword: "é•¿æ²™ç¾é£Ÿæ¨è",
  city: "é•¿æ²™",
  source: "auto",
  limit: 5,
});

// 3. æ¸²æŸ“ç»“æœ
{response.data.results.map(result => (
  <AnalysisResultCard
    key={result.note_id}
    result={result}
    onAddToFavorites={() => {}}
  />
))}
```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### 1. "æœç´¢å¤±è´¥" ä½†æ— é”™è¯¯ä¿¡æ¯

**åŸå› **: `success_count=0` - LLM å¤„ç†å¤±è´¥

**æ’æŸ¥æ­¥éª¤**:
```bash
# æ£€æŸ¥ API Key é…ç½®
curl http://localhost:8000/api/analyze/status
# æœŸæœ›: api_key_configured: true

# æŸ¥çœ‹åç«¯æ—¥å¿—
# åº”æ˜¾ç¤º: "Processing note mock_001: sentiment=positive, ..."
```

### 2. CORS é”™è¯¯

- **åŸå› **: å‰ç«¯åœ°å€æœªåŠ å…¥åç«¯ CORS ç™½åå•
- **å¤„ç†**: æ£€æŸ¥ `backend/main.py` çš„ CORS é…ç½®ï¼ˆå°†å½“å‰å‰ç«¯åœ°å€åŠ å…¥ allow_originsï¼‰

---

## æœ€åæ›´æ–°

2025-12-19
**ç»´æŠ¤è€…**: LiteTravel Team
