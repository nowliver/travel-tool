<任务启动协议>
- MUST: 接到新需求后，先输出一份“PRD for AI（精简版）”，再做任何代码修改
- MUST: PRD 输出后，等待你确认/修改意见；你确认后才开始实现
- CAN: 在你确认前允许做只读探索（read_file/grep），但不得改代码/改文档/跑有副作用命令

<PRD_for_AI_模板_精简版>
## 1. 目标
- 用一句话说明要实现什么

## 2. 当前上下文
- 涉及模块/文件路径
- 现状问题/约束点

## 3. 方案（高层）
- 核心数据流/调用链
- Mock 兜底策略（如适用）
- 错误处理策略

## 4. 分步计划（2-5 步）
- 每步产出可验收的结果

## 5. 验收标准（3-5 条）
- 可测试、可验证（包含无 Key 降级/错误提示等）
</PRD_for_AI_模板_精简版>
</任务启动协议>

---

<三文档更新协议>
- MUST: 每个任务完成前，更新以下三份文档并确保内容一致
  - docs/ARCHITECTURE.md
  - docs/TODO.md
  - docs/README.md
- MUST: TODO.md 里对已完成项打 [x]，并补充新发现的待办（如有）
</三文档更新协议>

---

<不可妥协规则>
- MUST NOT: 使用 pip / venv / virtualenv
- MUST: 后端一切 Python 操作使用 uv
  - uv add <pkg>
  - uv add --dev <pkg>
  - uv run <cmd>
  - uv sync
- MUST NOT: 手动编辑 pyproject.toml 的依赖部分
- MUST NOT: 手动编辑 uv.lock
- MUST NOT: 提交 backend/.env 到 git
- MUST NOT: 硬编码任何密钥/Token/账号信息
- MUST NOT: 使用原始 SQL（使用 SQLAlchemy ORM）
- MUST NOT: 使用 react-amap 或其他高德地图封装器（仅用 @amap/amap-jsapi-loader）
</不可妥协规则>

---

<环境变量规则>
- MUST: 所有环境变量统一放在 backend/.env（不入库）
- MUST: 前端通过 Vite envDir 指向 backend/ 读取 VITE_* 变量
- MUST: 只有“可公开配置”才使用 VITE_ 前缀
- 建议变量清单（按现有项目约定）:
  - JWT_SECRET_KEY
  - DATABASE_URL
  - AMAP_KEY_WEB                # 后端 WebService
  - AMAP_KEY_WEB_JS             # 后端配置用（如有）
  - VITE_AMAP_KEY_WEB_JS        # 前端地图加载
  - VOLCENGINE_API_KEY
  - VOLCENGINE_MODEL
  - (可选) VITE_USE_MOCK=true   # 强制 mock（调试）
</环境变量规则>

---

<多源数据与Mock兜底策略>
- MUST: “真实数据优先 + Mock 兜底”
- MUST: 任一真实数据源不可用（缺 Key / 网络失败 / API 返回异常）时
  - 不中断用户体验
  - 自动降级到 mock
  - 记录可追踪的降级原因（前端 console.warn / 后端 logger.warning）

<前端服务层_规则>
- MUST: 每个真实服务都要有对应 mock 实现放在 src/services/mock/
- MUST: src/services/*.ts 导出时统一做环境检测与降级封装
- SHOULD: 使用 VITE_USE_MOCK=true 强制走 mock 便于调试
- MUST: UI 组件不得直接 fetch 外部 API；必须通过 services 层

<后端LLM数据源_规则>
- MUST: /api/analyze/search 支持 source 参数
  - auto: 自动选择（优先真实数据源，失败降级 mock）
  - xiaohongshu: 强制小红书
  - mock: 强制 mock
- MUST: auto 的默认优先级（当前）
  - xiaohongshu -> mock
</多源数据与Mock兜底策略>

---

<前端工程规则>
<React>
- MUST: 仅使用函数组件 + Hooks
- SHOULD: 组件保持小而专注（拆分 UI 与业务逻辑）
</React>

<TypeScript>
- MUST: 严格类型；避免 any（AMap 运行时类型除外）
- SHOULD: 类型集中在 src/types/（遵循现有项目结构）
</TypeScript>

<Zustand>
- MUST NOT: 在 selector 中创建新数组/对象（避免无限渲染/引用变化）
  - 正确: useTripStore(s => s.days)
  - 错误: useTripStore(s => s.days.flatMap(...))
- SHOULD: 派生数据在组件内部 useMemo/useEffect 处理
</Zustand>

<地图集成>
- MUST: 仅使用 @amap/amap-jsapi-loader
- MUST: 缺少 VITE_AMAP_KEY_WEB_JS 时
  - 显示占位/提示
  - 功能降级但页面可用
</地图集成>

<错误提示>
- SHOULD: 使用 toast（项目已采用 react-hot-toast）替代 alert
- MUST: 网络错误/鉴权错误要有用户可理解的提示文案
</错误提示>
</前端工程规则>

---

<后端工程规则>
<FastAPI>
- MUST: 路由放在 backend/app/api/，使用 APIRouter 分模块
- MUST: 请求/响应用 Pydantic schema（backend/app/schemas/）
- MUST: 返回正确的 HTTP 状态码（400/401/403/404/500/503 等）
</FastAPI>

<SQLAlchemy>
- MUST: 使用 ORM 模型（backend/app/models/）
- MUST NOT: 原始 SQL
</SQLAlchemy>

<异步与I/O>
- SHOULD: 外部请求/IO 使用 async/await
- MUST: 任何外部依赖失败要可降级或可定位（日志 + 错误信息）
</异步与I/O>

<日志>
- SHOULD: 关键链路打印 info
- SHOULD: 降级与异常打印 warning/error（包含上下文：source、keyword、city）
</日志>
</后端工程规则>

---

<开发工作流>
- SHOULD: 先实现最小闭环（能跑通/能降级/能提示），再做体验优化
- MUST: 改动涉及架构/接口/环境变量时，同步更新三文档
- MUST: 不执行可能破坏环境/数据的命令（删除、覆盖、迁移）除非你明确确认
</开发工作流>

---

<完成定义_DoD>
- MUST: 功能实现符合 PRD 验收标准
- MUST: 无 Key 时可正常运行（mock 兜底生效）
- MUST: 单一数据源失败不影响全局功能（降级生效）
- MUST: 关键错误有提示（用户可理解）
- MUST: 关键降级有日志（可定位）
- MUST: TypeScript 编译不报错
- MUST: 后端启动无报错（uv run uvicorn）
- MUST: docs/ARCHITECTURE.md 已更新
- MUST: docs/TODO.md 已更新
- MUST: docs/README.md 已更新
</完成定义_DoD>