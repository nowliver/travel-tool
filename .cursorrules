# LiteTravel - Master Development Rules

> **Version**: 2.0.0  
> **Last Updated**: 2025-12-11  
> **Toolchain**: uv + FastAPI + React + TypeScript

---

## üéØ Project Overview

LiteTravel is a **full-stack** travel planning application combining map visualization with itinerary management. The architecture follows a **React + Zustand** frontend with a **FastAPI** backend for user authentication and data persistence.

**Core Concept**: "Âú∞ÂõæÂèØËßÜÂåñËßÑÂàí + ËÆ∞‰∫ãÊú¨ÂºèËÆ∞ÂΩï + ‰∫ëÁ´ØÂêåÊ≠•"

---

## üìö The Triple Update Protocol

**CRITICAL**: Every task completion MUST update these three documents:

1. **`ARCHITECTURE.md`** - System architecture, data flows, component maps
   - Update when: Adding/modifying components, services, or data models
   - Include: Component paths, interfaces, architectural decisions

2. **`TODO.md`** - Task tracking and project roadmap
   - Update when: Completing tasks, discovering new requirements
   - Mark completed items with `[x]`, add new items as needed

3. **`README.md`** - User-facing documentation
   - Update when: Adding features, changing setup steps, modifying APIs
   - Include: Installation steps, usage examples, configuration

**Enforcement**: Before marking any task as complete, verify all three documents are updated.

---

## üõ†Ô∏è Technology Stack

### Frontend
- **Framework**: React 18+ with TypeScript
- **Build Tool**: Vite 6
- **Styling**: TailwindCSS
- **State Management**: Zustand 5
- **Map Integration**: @amap/amap-jsapi-loader (È´òÂæ∑Âú∞Âõæ)
- **Drag & Drop**: @dnd-kit/core, @dnd-kit/sortable
- **Icons**: Lucide React

### Backend
- **Framework**: Python FastAPI
- **Package Manager**: **uv** (MANDATORY - NO pip/venv)
- **Database**: SQLite (dev) / PostgreSQL (prod)
- **ORM**: SQLAlchemy
- **Authentication**: JWT with bcrypt
- **Validation**: Pydantic

---

## üîß Python Environment Management (uv)

### CRITICAL: Use uv ONLY

**NEVER use pip, venv, or virtualenv. All Python operations MUST use uv.**

### Common Commands

```bash
# Initialize project (already done)
uv init --python ">=3.10"

# Add production dependency
uv add <package>

# Add development dependency
uv add --dev <package>

# Install all dependencies
uv sync

# Run Python script/command
uv run python main.py
uv run uvicorn main:app --reload

# Run tests
uv run pytest

# Update dependencies
uv lock --upgrade
```

### Project Structure

```
backend/
‚îú‚îÄ‚îÄ pyproject.toml    # Project metadata & dependencies (uv managed)
‚îú‚îÄ‚îÄ uv.lock           # Lock file (DO NOT edit manually)
‚îú‚îÄ‚îÄ .venv/            # Virtual environment (auto-managed by uv)
‚îú‚îÄ‚îÄ main.py           # FastAPI entry point
‚îî‚îÄ‚îÄ app/
    ‚îú‚îÄ‚îÄ api/          # API endpoints
    ‚îú‚îÄ‚îÄ core/         # Config & security
    ‚îú‚îÄ‚îÄ db/           # Database layer
    ‚îú‚îÄ‚îÄ models/       # SQLAlchemy models
    ‚îî‚îÄ‚îÄ schemas/      # Pydantic schemas
```

### Rules for Backend Development

1. **Adding Dependencies**: ALWAYS use `uv add <package>`
2. **Running Code**: ALWAYS use `uv run <command>`
3. **No Manual Edits**: NEVER edit `pyproject.toml` dependencies manually
4. **Lock File**: Commit `uv.lock` to version control
5. **Environment**: Let uv manage `.venv` automatically

---

## üìê Project Structure

### Frontend (`src/`)

```
src/
  components/
    auth/          # Authentication UI (AuthModal, UserMenu, PlansModal)
    itinerary/     # Left panel: Day tabs, node cards, search, drag & drop
    layout/        # Shell component (left/right split layout)
    map/           # Right panel: AMap container, markers, polylines
    ui/            # Reusable UI components
    views/         # Feature views (AttractionsView, etc.)
  services/
    api/           # Backend API clients (apiClient, authService, planService)
    mock/          # Mock implementations (MUST exist for all services)
    *.ts           # Service exports (auto-fallback to mock if no env key)
  store/
    tripStore.ts   # Trip state management
    authStore.ts   # Authentication state
  types.ts         # Core domain types
  utils/           # Demo data, formatters, helpers
```

### Backend (`backend/`)

See structure above in uv section.

---

## üèóÔ∏è Core Architectural Principles

### 1. Mock-First Strategy (Frontend)
- **CRITICAL**: All frontend services MUST have mock implementations in `src/services/mock/`
- Service exports MUST check for env vars and fallback to mock
- Mock data should use realistic coordinates (real Changsha coordinates, not 0,0)
- Application MUST work without any API keys configured

### 2. State Management with Zustand
- Use Zustand for global state (`useTripStore`, `useAuthStore`)
- **IMPORTANT**: Avoid creating new arrays/objects in selectors to prevent infinite loops
  - ‚úÖ Good: `const days = useTripStore((s) => s.days)`
  - ‚ùå Bad: `const allNodes = useTripStore((s) => s.days.flatMap(...))`
  - Instead, derive arrays in `useEffect` or component logic

### 3. Backend API Design
- **RESTful**: Follow REST conventions for all endpoints
- **JWT Auth**: Use `get_current_user` dependency for protected routes
- **Error Handling**: Return standard HTTP status codes (401, 403, 404, 500)
- **Validation**: Use Pydantic schemas for request/response validation
- **Async**: Prefer async/await for I/O operations

### 4. Map Integration
- Use `@amap/amap-jsapi-loader` directly (NOT react-amap wrapper)
- Directly manipulate `AMap.Map` instance for custom polylines and markers
- Map markers should use different colors per day (dayColors array)
- Always handle missing API key gracefully (show placeholder message)

---

## üíª Code Style Guidelines

### TypeScript (Frontend)
- Use strict TypeScript (`strict: true` in tsconfig)
- Define all domain types in `src/types.ts`
- Use interfaces for data structures, types for unions
- Avoid `any` except for AMap runtime types

### Python (Backend)
- Follow PEP 8 style guide
- Use type hints for all function signatures
- Use async/await for I/O operations
- Keep functions focused and small
- Use Pydantic for data validation

### React Components
- Use functional components with hooks
- Prefer named exports: `export function ComponentName() {}`
- Keep components focused and small
- Extract reusable logic into custom hooks

### Naming Conventions
- **Components**: PascalCase (`NodeCard.tsx`, `AuthModal.tsx`)
- **Files**: Match component/module name
- **Functions/variables**: camelCase (TS), snake_case (Python)
- **Types/interfaces**: PascalCase
- **Constants**: UPPER_SNAKE_CASE

### TailwindCSS
- Use Tailwind utility classes exclusively
- Prefer semantic color names: `slate-800`, `emerald-500`, `red-300`
- Use responsive prefixes when needed
- Keep custom CSS minimal (only in `index.css`)

---

## üîê Security Best Practices

### Backend
1. **Never hardcode secrets** - Use `.env` files (excluded from git)
2. **Password hashing** - Always use bcrypt with salt
3. **JWT tokens** - Set reasonable expiration times
4. **Input validation** - Use Pydantic schemas for all inputs
5. **SQL injection** - Use SQLAlchemy ORM (never raw SQL)

### Frontend
1. **Token storage** - Store JWT in localStorage (consider httpOnly cookies for production)
2. **API errors** - Handle 401/403 gracefully, redirect to login
3. **Sensitive data** - Never log tokens or passwords
4. **CORS** - Backend CORS configured for specific origins only

---

## üîÑ Development Workflow

### Starting Development

**Backend**:
```bash
cd backend
uv sync                    # Install dependencies
uv run uvicorn main:app --reload --port 8000
```

**Frontend**:
```bash
npm install                # First time only
npm run dev                # Start Vite dev server
```

### Adding a New Feature

1. **Plan**: Update `TODO.md` with new task
2. **Implement**: Write code following patterns
3. **Test**: Verify functionality works
4. **Document**: Update `ARCHITECTURE.md` and `README.md`
5. **Commit**: Commit with descriptive message

### Adding Backend Dependencies

```bash
cd backend
uv add <package>           # Production dependency
uv add --dev <package>     # Development dependency
uv sync                    # Update lock file
```

### Backend API Development

1. **Define Schema**: Create Pydantic models in `app/schemas/`
2. **Create Model**: Define SQLAlchemy model in `app/models/`
3. **Write Endpoint**: Implement route in `app/api/`
4. **Add Auth**: Use `Depends(get_current_user)` for protected routes
5. **Test**: Use Swagger UI at `http://localhost:8000/docs`

---

## üìã Key Patterns

### Frontend: Adding New Service

1. Create mock in `src/services/mock/mockServiceName.ts`
2. Create export in `src/services/serviceName.ts` with env check
3. Export interface and implementation

### Frontend: Adding New Component

1. Place in appropriate `components/` subdirectory
2. Use TypeScript props interface
3. Follow existing component patterns
4. Use Zustand for state when needed

### Backend: Adding New Endpoint

1. Define Pydantic schemas in `app/schemas/`
2. Create route in `app/api/`
3. Add to router in `main.py`
4. Test with Swagger UI

### Drag & Drop

- Use `@dnd-kit` for all drag operations
- Wrap draggable lists in `DndContext` and `SortableContext`
- Use `useSortable` hook for individual items
- Handle both same-day reordering and cross-day moves

---

## ‚úÖ Important Rules

### DO:
- ‚úÖ Use `uv` for ALL Python operations
- ‚úÖ Update Triple Docs (ARCHITECTURE.md, TODO.md, README.md) after each task
- ‚úÖ Always provide mock implementations for frontend services
- ‚úÖ Use Zustand selectors that return stable references
- ‚úÖ Handle missing API keys gracefully
- ‚úÖ Use type hints in Python, strict TypeScript in frontend
- ‚úÖ Follow RESTful conventions for APIs
- ‚úÖ Use JWT for authentication
- ‚úÖ Validate all inputs with Pydantic
- ‚úÖ Keep components small and focused
- ‚úÖ Test drag & drop across days
- ‚úÖ Ensure map updates when store changes

### DON'T:
- ‚ùå Use pip, venv, or virtualenv (USE UV ONLY)
- ‚ùå Skip Triple Update Protocol
- ‚ùå Create new arrays/objects in Zustand selectors
- ‚ùå Hardcode API keys or secrets
- ‚ùå Use `react-amap` or other AMap wrappers
- ‚ùå Store commute info as separate nodes
- ‚ùå Skip mock implementations
- ‚ùå Use `any` in TypeScript (except AMap runtime)
- ‚ùå Break the mock-first strategy
- ‚ùå Modify state directly (always use Zustand actions)
- ‚ùå Commit `.env` files to git
- ‚ùå Use raw SQL queries (use SQLAlchemy ORM)

---

## üåê Environment Variables

### Frontend (`.env.local`)
```
VITE_AMAP_KEY=<your-amap-key>
VITE_GOOGLE_API_KEY=<your-gemini-key>
VITE_API_BASE_URL=http://localhost:8000
VITE_USE_MOCK=false
```

### Backend (`backend/.env`)
```
JWT_SECRET_KEY=<strong-secret-key>
JWT_ALGORITHM=HS256
ACCESS_TOKEN_EXPIRE_MINUTES=1440
DATABASE_URL=sqlite:///./litetravel.db
```

---

## üß™ Testing Considerations

- Application should work entirely in mock mode (frontend)
- Test drag & drop within and across days
- Test map marker updates when nodes change
- Test city change triggers map recenter
- Test localStorage save/load functionality
- Test authentication flow (register, login, logout)
- Test protected API routes return 401 without token
- Test CRUD operations for itinerary plans

---

## üìù Common Tasks

### Adding a New Day
- Use `addDay()` action from store
- Automatically increments `day_index`
- Optionally sets date based on previous day

### Adding a Node from Search
- Call `mapService.search(keyword)`
- Create `PlanNode` from `MapSearchResult`
- Use `addNode(dayIndex, node)`

### Moving Nodes
- Same day: `reorderNodes(dayIndex, oldIndex, newIndex)`
- Cross day: `moveNodeAcrossDays(fromDayIndex, toDayIndex, nodeId, toIndex?)`

### Saving/Loading Plans
- **Local**: `localStorage.setItem('litetravel:plan:{city}', JSON.stringify({meta, days}))`
- **Cloud**: `planService.savePlan(id, title, meta, days)` (requires auth)
- **Load**: Parse JSON and call `setTrip({meta, days})`

### User Authentication
- **Register**: `authService.register({email, password})`
- **Login**: `authService.login({email, password})`
- **Logout**: `authService.logout()`
- **Check Auth**: `authService.isAuthenticated()`

---

## üìñ Documentation References

- [FastAPI Docs](https://fastapi.tiangolo.com/)
- [uv Documentation](https://docs.astral.sh/uv/)
- [SQLAlchemy Docs](https://docs.sqlalchemy.org/)
- [Zustand Docs](https://docs.pmnd.rs/zustand)
- [AMap JS API](https://lbs.amap.com/api/javascript-api/summary)
- [@dnd-kit Docs](https://docs.dndkit.com/)

---

## üöÄ Notes

- The app is designed to work offline-first (with mocks)
- Real API integration is optional with graceful degradation
- Focus on user experience: smooth drag & drop, clear visual feedback
- Map and list must stay in sync at all times
- Backend uses JWT for stateless authentication
- All passwords are hashed with bcrypt
- Use uv for consistent Python environment management
